name: 20250819-Build FFmpeg with AV3A (Simplified)

on:
  workflow_dispatch:
    inputs:
      av3a_version:
        description: 'AV3A library version (e.g. v1.0)'
        required: true

jobs:
  build-ffmpeg:
    runs-on: windows-latest
    
    steps:
      - name: ğŸ“¥ Checkout FFmpeg
        uses: actions/checkout@v4
        with:
          repository: nicaicaii/ffmpeg-6.1
          path: ffmpeg

      - name: ğŸ“¦ Setup AV3A libraries
        run: |
          # åˆ›å»ºæ ‡å‡†ç›®å½•ç»“æ„
          mkdir -p ffmpeg/av3a/{include,lib/pkgconfig}
          
          # è¿™é‡Œåº”è¯¥æ˜¯ä»ä½ çš„å­˜å‚¨åº“è·å–é¢„ç¼–è¯‘åº“æ–‡ä»¶
          # ç¤ºä¾‹ï¼šé€šè¿‡curlä¸‹è½½é¢„ç¼–è¯‘çš„AV3Aåº“
          curl -L https://github.com/tongxunlu/avs3a/releases/download/v1.1/av3ad-v1.1-win64.zip -o av3a.zip
          7z x av3a.zip -o ffmpeg/av3a/
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          ls -R ffmpeg/av3a/

      - name: ğŸ› ï¸ Setup MSYS2 environment
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            base-devel
            git
            make
            pkg-config
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-gnutls

      - name: ğŸ”¨ Build FFmpeg
        shell: msys2 {0}
        run: |
          cd ffmpeg
          ./configure \
            --extra-cflags="-I./av3a/include" \
            --extra-ldflags="-L./av3a/lib -lavs3a --static" \
            --enable-libarcdav3a \
            --enable-libuavs3d \
            --enable-static \
            --disable-shared \
            --enable-gpl \
            --enable-nonfree \
            --disable-ffplay \
            --disable-ffprobe \
            --pkg-config-flags="--static"
          
          make -j$(nproc)
          make install

      - name: ğŸ“¤ Package and Upload
        run: |
          # å¤åˆ¶åˆ°å·¥ä½œç›®å½•
          cp /usr/local/bin/ffmpeg.exe .
          
          # åˆ›å»ºåŒ…å«æ‰€æœ‰ä¾èµ–çš„å®Œæ•´åŒ…
          7z a -tzip ffmpeg-av3a-${{ github.event.inputs.av3a_version }}-windows.zip \
            ffmpeg.exe \
            ffmpeg/av3a/lib/*.lib
            
        shell: bash

      - name: â¬†ï¸ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-av3a-${{ github.event.inputs.av3a_version }}-windows
          path: |
            ffmpeg.exe
            ffmpeg-av3a-*.zip
